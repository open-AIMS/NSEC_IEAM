---
title: "Exploring alternative Bayesian estimates of low- and no-effect concentration thresholds"
author: "Rebecca Fisher"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

require(jagsNEC)
require(tidyverse)
library(ggplot2)
library(ggthemes) 
library(ggnewscale)
library(kableExtra)
library(flextable)
library(officer)
library(ggtext)
library(ggh4x)
library(scales)
library(cowplot)
library(gridGraphics)

fig_dir <- "C:/Users/rfisher/Australian Institute of Marine Science/Program 2.3 - TERA - General/Projects/3158 Statistical Ecotoxicology/Estimating no effect/MS/revision1/"

source('functions.R')

load(file="binomial_sim_results.RData")
load(file = "fitted_binom_examples.RData")

load("cu_pred_vals.RData") #case study 1
load("caste_study_results.RData")


x.range <- c(0.1, 10)
x.vec <- seq(x.range[1], x.range[2], length=50)

true.vals <- do.call("rbind", true.endpoints) %>%
  mutate(estimate=gsub("C1", "C01", endpoint),
         estimate=gsub("C5", "C05", endpoint),
         estimate=gsub("C010", "C10", endpoint)) |> 
  mutate(scenarios_f = as_factor(scenarios), 
          scenarios_f = fct_relevel(scenarios_f,"NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) 

true.vals.2<-true.vals %>% mutate(scenarios_f = as_factor(scenarios), 
          scenarios_f = fct_relevel(scenarios_f,"NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"), 
          endpoint=fct_relevel(endpoint, "NEC", "EC1", "EC5", "EC10")) %>% 
    mutate(y_2 = if_else(str_detect(scenarios, "NEC")&endpoint %in% c("EC1", "EC5", "EC10"),  NA, y))

 
dat <- all.sim.out %>%
  mutate(est.NEC=NEC_X50.,
         est.NSEC=NSEC01.ECxsigmoidal_X50.,
         est.N.S.EC=NSEC01.ECxsigmoidal_X50.*ECxsigmoidal + NEC_X50.*NEC3param,         
         est.EC10=ECx10.ECxsigmoidal_X50.*ECxsigmoidal + ECx10.NEC3param_X50.*NEC3param,
         est.EC05=ECx05.ECxsigmoidal_X50.*ECxsigmoidal + ECx05.NEC3param_X50.*NEC3param,
         est.EC01=ECx01.ECxsigmoidal_X50.*ECxsigmoidal + ECx01.NEC3param_X50.*NEC3param,
         est.NEC.up=NEC_X97.5.,
         est.NSEC.up=NSEC01.ECxsigmoidal_X97.5.*ECxsigmoidal + NSEC01.NEC3param_X97.5.*NEC3param,
         est.EC10.up=ECx10.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx10.NEC3param_X97.5.*NEC3param,
         est.EC05.up=ECx05.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx05.NEC3param_X97.5.*NEC3param,
         est.EC01.up=ECx01.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx01.NEC3param_X97.5.*NEC3param,     
         est.NEC.lw=NEC_X2.5.,
         est.NSEC.lw=NSEC01.ECxsigmoidal_X2.5.*ECxsigmoidal + NSEC01.NEC3param_X2.5.*NEC3param,
         est.EC10.lw=ECx10.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx10.NEC3param_X2.5.*NEC3param,
         est.EC05.lw=ECx05.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx05.NEC3param_X2.5.*NEC3param,
         est.EC01.lw=ECx01.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx01.NEC3param_X2.5.*NEC3param,
         label=paste(n, " reps (", trials, " trials)", sep=""))  %>% 
  mutate(label=as.factor(label), 
         scenarios_f = as_factor(scenarios), 
         label = fct_relevel(label, 
             "5 reps (10 trials)", "5 reps (20 trials)", "10 reps (10 trials)", "10 reps (20 trials)"))
# check treatments
dat |> 
  select(total.reps, n, trials, n.treatments) |> 
  unique() |> 
  View()

nsec_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.NSEC"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100

n.s.ec_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.N.S.EC"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100


ec1_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.EC01"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100

ec5_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.EC05"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100

ec10_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.EC10"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100

nec_ecx_vals <- ((0.9-sapply(1:nrow(dat),  FUN = function(i){  
  param_vec <- dat[i, c("top", "beta", "NEC", "d")]
  x_val <- dat[i, "est.NEC"]
  unlist(estECX_vals(x=x_val, params = param_vec))  
})) / 0.9) *100

dat$nsec_ecx_vals <- nsec_ecx_vals
dat$n.s.ec_ecx_vals <- n.s.ec_ecx_vals
dat$ec1_ecx_vals <- ec1_ecx_vals
dat$ec5_ecx_vals <- ec5_ecx_vals
dat$ec10_ecx_vals <- ec10_ecx_vals
dat$nec_ecx_vals <- nec_ecx_vals

coverage <- dat %>% 
  dplyr::mutate(
    # ac.NEC=ifelse(NEC>est.NEC.lw & NEC<est.NEC.up, 1, 0),
    # ac.EC10=ifelse(EC10>est.EC10.lw & EC10<est.EC10.up, 1, 0),
    # ac.EC05=ifelse(EC5>est.EC05.lw & EC5<est.EC05.up, 1, 0),
    # ac.EC01=ifelse(EC1>est.EC01.lw & EC1<est.EC01.up, 1, 0),
    # nsc.NEC=ifelse(NEC>est.NSEC.lw & NEC<est.NSEC.up, 1, 0),
    # nsc.EC10=ifelse(EC10>est.NSEC.lw, 1, 0)
    ## actual endpoints
    fn.NEC=ifelse(NEC<est.NEC.lw, 1, 0),
    fn.EC10=ifelse(EC10<est.EC10.lw, 1, 0),
    fn.EC05=ifelse(EC5<est.EC05.lw, 1, 0),
    fn.EC01=ifelse(EC1<est.EC01.lw, 1, 0),
    ns_fn.NEC=ifelse(NEC<est.NSEC.lw, 1, 0),
    ns_fn.EC10=ifelse(EC10<est.NSEC.lw, 1, 0),
    ns_fn.EC05=ifelse(EC5<est.NSEC.lw, 1, 0),
    ns_fn.EC01=ifelse(EC1<est.NSEC.lw, 1, 0),
    fp.NEC=ifelse(NEC>est.NEC.up, 1, 0),
    fp.EC10=ifelse(EC10>est.EC10.up, 1, 0),
    fp.EC05=ifelse(EC5>est.EC05.up, 1, 0),
    fp.EC01=ifelse(EC1>est.EC01.up, 1, 0),
    ns_fp.NEC=ifelse(NEC>est.NSEC.up, 1, 0),
    ns_fp.EC10=ifelse(EC10>est.NSEC.up, 1, 0),
    ns_fp.EC05=ifelse(EC5>est.NSEC.up, 1, 0),
    ns_fp.EC01=ifelse(EC1>est.NSEC.up, 1, 0),
    ## NSEC approximation
    nec_fp.EC10=ifelse(EC10>est.NEC.up, 1, 0),
    nec_fp.EC05=ifelse(EC5>est.NEC.up, 1, 0),
    nec_fp.EC01=ifelse(EC1>est.NEC.up, 1, 0),
    nec_fp.NEC=ifelse(NEC>est.NEC.up, 1, 0),
    ## NEC approximation
    nec_fn.EC10=ifelse(EC10<est.NEC.lw, 1, 0),
    nec_fn.EC05=ifelse(EC5<est.NEC.lw, 1, 0),
    nec_fn.EC01=ifelse(EC1<est.NEC.lw, 1, 0),
    nec_fn.NEC=ifelse(NEC<est.NEC.lw, 1, 0),    
    
  ) %>% 
  dplyr::select(key, 
                fp.NEC, fp.EC10, fp.EC05, fp.EC01, 
                ns_fp.NEC, ns_fp.EC10, ns_fp.EC05, ns_fp.EC01,
                fn.NEC, fn.EC10, fn.EC05, fn.EC01, 
                ns_fn.NEC, ns_fn.EC10, ns_fn.EC05, ns_fn.EC01,
                nec_fp.NEC, nec_fp.EC10,  nec_fp.EC05,  nec_fp.EC01,
                nec_fn.NEC, nec_fn.EC10, nec_fn.EC05, nec_fn.EC01, 
                total.reps) %>% 
  dplyr::group_by(key) %>% 
  dplyr::summarise_all(mean, .groups="keep", na.rm=TRUE) %>% 
  data.frame() %>% 
  left_join(scenario.dat)

# boxplot summary
quantiles_95 <- function(x) {
  r <- quantile(x, probs=c(0.025, 0.2, 0.5, 0.8, 0.975))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}


true_ec_dat <-expand.grid(
   scenarios=unique(dat$scenarios), endpoint = c("EC1", "EC5", "EC10")) |> 
  mutate(y=as.numeric(gsub("EC", "", endpoint)))  |> 
  mutate(scenarios_f = as_factor(scenarios), 
          scenarios_f = fct_relevel(scenarios_f,"NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) 

true_all_dat <-expand.grid(
   scenarios=unique(dat$scenarios),
   endpoint = c("EC01", "EC05", "EC10", "NEC", "NSEC", "N(S)EC")) |> 
  mutate(y=as.numeric(gsub("EC", "", endpoint)))  |> 
  mutate(y=ifelse(is.na(y), 0, y))  |> 
  mutate(scenarios_f = as_factor(scenarios), 
          scenarios_f = fct_relevel(scenarios_f,"NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) 

#EC1 case study 2
ec1_coral <- extract_ECx(Coral.out4.all, ECx.val = 1)
ec1_aa <- extract_ECx(out.aa.all, ECx.val = 1)
ec1_aa <- extract_ECx(out.aa.all, ECx.val = 10)
ec1_nd <- extract_ECx(out.nd.all, ECx.val = 1)
ec1_urchin <- extract_ECx(Urchin.out2, ECx.val = 1)
exp(ec1_coral)
exp(ec1_aa)
exp(ec1_nd)
exp(ec1_urchin)

```


## Figure - example simulated data 

Figure showing the models used to create the data for the simulation study. 

```{r plot-example, fig.height=5, fig.fullwidth=TRUE, fig.cap="\\label{fig:plot_scenarios}A sigmoidal concentration-response experiment showing estimation of NSEC. The solid black line shows the fitted Bayesian model. The horizontal red line is the lower 1 percentile of the lowest concentration treatment (the control). The blue lines show posterior predicted values of the response for each MCMC sample. NSEC for each MCMC sample is estimated as the intersection between the red and blues lines."}

fit.i <- fitted.binom$'12_5_0.9_10_Sigmoidal 1'$mod.fits$ECxsigmoidal
dat.i <- fit.i$mod.dat
y.i <- fit.i$pred.vals$y
post.i <- fit.i$pred.vals$posterior
x.i <- fit.i$pred.vals$x
lw.i <- quantile(post.i[1,], probs = 0.01)

plot(jitter(dat.i$x, factor=0.5), dat.i$y/dat.i$trials, pch=16, col=adjustcolor("black", alpha=0.25),
     xlab="Concentration", ylab="Response probability", bty="L")

abline(h=lw.i, col="red")
for(l in 1:50){
  lines(x.i, post.i[,l], col=adjustcolor("blue", alpha=0.1))
}
lines(x.i, y.i, lwd=1.25)

```


```{r ECxsigmoidal, include=TRUE, echo=TRUE}
ECxsigmoidal <- function(x, top, beta, d) {
  y.pred <- top * exp(-beta * (x)^d)
  
  return(y.pred)
}
```


```{r NEC3param, include=TRUE, echo=TRUE}
NEC3param <- function(x, NEC, top, beta) {
  pre.index <- which(x <= NEC)
  post.index <- which(x > NEC)
  x.seq.pre <- x[pre.index]
  x.seq.post <- x[post.index]
  
  y.pred <- rep(NA, length(x))
  
  y.pred.pre <- top
  y.pred.post <- top * exp(-beta * (x.seq.post - NEC))
  
  y.pred[pre.index] <- y.pred.pre
  y.pred[post.index] <- y.pred.post
  
  return(y.pred)
}
```


```{r plot-scenarios, fig.height=5, fig.fullwidth=TRUE, fig.cap="\\label{fig:plot_scenarios}Models used for each scenario in the simulation study"}
scenarios <- names(scenarios.list)
scenarios.dat <- do.call("rbind", scenarios.list) %>%
  data.frame() %>%
  rownames_to_column(var = "scenarios")

x.range <- c(0.1, 10)
x.vec8 <- seq(x.range[1], x.range[2], length=8)
x.vec12 <- seq(x.range[1], x.range[2], length=12)

png("figure curves.jpg", height=120, width=200, units="mm", bg = "white", res = 2000)
par(bty="n")
plot(x.vec, ECxsigmoidal(x=x.vec, top=0.9, beta=0.01, d=2), ylim = c(0,1), 
     pch=NA, ylab="Response (y)", xlab="Concentration (x)")
arrows(x0=scenarios.dat$NEC[2], y0=0.2, x1=scenarios.dat$NEC[2], y1=0,
       col = 1, lwd=3, length = 0.1)
arrows(x0=scenarios.dat$NEC[4], y0=0.2, x1=scenarios.dat$NEC[4], y1=0,
       col = 2, lwd=3, length = 0.1)
abline(h=0.9*0.9, col = "blue", lwd=1, lty=2)
text(x = na.omit(scenarios.dat$NEC), y = 0.2, labels = c("NEC 1", "NEC 2"), col=1:2, pos=3)
text(x = 1, y = 0.9*0.9, labels = "10% effect", col="blue", pos=1)
axis(side = 1, labels = NA, at = x.vec12, col.ticks = "#2D6480", lwd.ticks=3)
axis(side = 1, labels = NA, at = x.vec8, col.ticks = "#B3AE36", lwd.ticks=3)

lines(x.vec, do.call(ECxsigmoidal, c(list(x.vec), as.list(na.omit(scenarios.list$`Sigmoidal 1`)))), col=1)
lines(x.vec, do.call(ECxsigmoidal, c(list(x.vec), as.list(na.omit(scenarios.list$`Sigmoidal 2`)))), col=2)

lines(x.vec, do.call(NEC3param, c(list(x.vec), as.list(na.omit(scenarios.list$`NEC 1`)))), col=1, lty=2)
lines(x.vec, do.call(NEC3param, c(list(x.vec), as.list(na.omit(scenarios.list$`NEC 2`)))), col=2, lty=2)

legend("right", legend=scenarios,
       lty=c(1,2,1,2,1,2), col=c(1,1,2,2,4,4), bty = "n")
legend("top", legend=c("8 treatments", "12 treatments"), col = c("#B3AE36", "#2D6480"), 
       lty=1, bty="n", lwd=3, ncol = 2)
dev.off()
```
## Figure - simulated data examples

```{r sims}
sim_dat_ret <- do.call("rbind", strsplit(names(sim.dat.binom), split = "_")) |> 
  data.frame() |> 
  mutate(key = names(sim.dat.binom),
         n.treatments = X1,
         n.replicates = X2,
         n.trials = X4,
         scenario = X5) |> 
  dplyr::select(key, n.treatments, n.replicates, n.trials, scenario)

all_sim_examples_dat<- lapply(sim_dat_ret$key, FUN = function(x){
  data.frame(fitted.binom[[x]]$mod.fits$ECxsigmoidal$mod.dat)
})
names(all_sim_examples_dat) <- sim_dat_ret$key

all_sim_examples_dat <- all_sim_examples_dat |> bind_rows(.id = "key") |> 
  left_join(sim_dat_ret) |> 
  mutate(label=factor(paste(n.replicates, " reps (", n.trials, " trials)", sep="")))  %>% 
  filter(label=="5 reps (10 trials)" | label=="10 reps (20 trials)") %>%
  mutate(Model = ifelse(grepl("NEC", scenario), "NEC", "Sigmoidal")) |> 
  mutate(label = fct_relevel(label, 
             "5 reps (10 trials)", "5 reps (20 trials)", "10 reps (10 trials)", "10 reps (20 trials)"))


all_sim_examples_dat |> 
  ggplot(aes(x=x, y=y/trials, col = scenario)) + 
  geom_jitter(alpha=0.3) +
  facet_grid(n.replicates + n.trials ~ n.treatments + Model) +
  ylab("Survival") +
  xlab("Concentration") +  theme_minimal()+
  theme(strip.text=element_text(face="bold")) 

ggsave("figure simdat.jpg", height=180, width=200,units="mm", bg = "white")

scenarios <- names(scenarios.list)
scenarios.dat <- do.call("rbind", scenarios.list) %>%
  data.frame() %>%
  rownames_to_column(var = "scenarios")

x.range <- c(0.1, 10)
x.vec8 <- seq(x.range[1], x.range[2], length=8)
x.vec12 <- seq(x.range[1], x.range[2], length=12)

 # scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f")) 
p1 <- ~{
  par(bty="n", cex=0.75, oma=c(0,0,0,0))
  plot(x.vec, ECxsigmoidal(x=x.vec, top=0.9, beta=0.01, d=2), ylim = c(0,1), 
       pch=NA,   ylab="", xlab="")
  arrows(x0=scenarios.dat$NEC[2], y0=0.2, x1=scenarios.dat$NEC[2], y1=0,
         col = "#41b6c4", lwd=3, length = 0.1)
  arrows(x0=scenarios.dat$NEC[4], y0=0.2, x1=scenarios.dat$NEC[4], y1=0,
         col = "#41b6c4", lwd=3, length = 0.1)
  abline(h=0.9*0.9, col = "#91003f", lwd=1, lty=2)
  text(x = na.omit(scenarios.dat$NEC), y = 0.2, labels = c("NEC 1", "NEC 2"), col="#41b6c4", pos=3)
  text(x = 1, y = 0.9*0.9, labels = "10% effect", col="#91003f", pos=1)
  axis(side = 1, labels = rep("", length(x.vec12)), at = x.vec12, col.ticks = "#2D6480", lwd.ticks=3)
  axis(side = 1, labels = rep("", length(x.vec8)), at = x.vec8, col.ticks = "#B3AE36", lwd.ticks=3)

  lines(x.vec, do.call(ECxsigmoidal, c(list(x.vec), as.list(na.omit(scenarios.list$`Sigmoidal 1`)))), col=1, lty=1)
  lines(x.vec, do.call(ECxsigmoidal, c(list(x.vec), as.list(na.omit(scenarios.list$`Sigmoidal 2`)))), col=1, lty=2)

  lines(x.vec, do.call(NEC3param, c(list(x.vec), as.list(na.omit(scenarios.list$`NEC 1`)))), col="#41b6c4", lty=1)
  lines(x.vec, do.call(NEC3param, c(list(x.vec), as.list(na.omit(scenarios.list$`NEC 2`)))), col="#41b6c4", lty=2)

  legend("right", legend=scenarios,
         lty=c(1,1,2,2), 
         col=c(1,"#41b6c4",1,"#41b6c4"), 
         bty = "n")
  legend("top", legend=c("8 treatments", "12 treatments"), 
         col = c("#B3AE36", "#2D6480"),
         lty=1, bty="n", lwd=3, ncol = 2, pch=16, cex = 1.25)
  mtext(side = 1, text = "Concentration (x)", line = 2, cex=0.9)
  mtext(side = 2, text = "Response (y)", line = 2, cex=0.9)
  }

p2 <- all_sim_examples_dat |> 
  ggplot(aes(x=x, y=y/trials, col = n.treatments)) + 
  geom_jitter(alpha=0.5) +
  facet_grid(label ~ scenario) +
  ylab("Response (y)") +
  xlab("Concentration (x)") +  
  theme_minimal()+
  scale_colour_manual(values=c("#B3AE36","#2D6480"))+
  theme(strip.text=element_text(face="bold"),
        legend.position = "none") 

plot_grid(p1, p2, labels=c("A", "B"), ncol=1, nrow=2, rel_heights = c(0.5, 0.5))
ggsave("figure sims_comb.jpg", height=200, width=200, units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 1.jpg", sep=""), height=200, width=200, units="mm", bg = "white")
```

## Figure weights

```{r Figure weights, fig.cap="\\label{fig:plot_weights}DIC based model weight for the NEC3param model for each scenario as a function of the sample density (total.reps) and the number of experimental treatment levels (n.treatments)."}
#treat models as individuals keep them in their facets 

grob1 <- 
  dat %>% 
mutate(NEC3param=ifelse(grepl("Sig", scenarios), 1-NEC3param, NEC3param)) |> 
ggplot(aes(label, NEC3param, fill=n.treatments)) +
  geom_boxplot(aes(), position=position_dodge2(),outlier.shape=NA)+
  #stat_summary(fun.data = quantiles_95, geom="boxplot", position=position_dodge2())  +
  geom_point(alpha=0.25, pch=21,position = position_jitterdodge(), colour="black") +
  geom_hline(aes(yintercept=0.5))+
    theme_minimal() +

  coord_cartesian(clip = "off") +
  scale_y_continuous(name="Weight of underlying model", limits=c(NA, 1.1), breaks=c(0,0.25,0.5,0.75,1)) +
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  labs(x="", fill="Treatments", tag="Treatments") +

  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.tag.position=c(0.03, 0.925), 
        plot.tag=element_text(size=8)) +
       facet_wrap(~scenarios, nrow = 1, scales = "free_x")
   #facet_grid(~scenarios_f+n.treatments, scales="free",space = "free")

grob2 <- 
  dat |> 
  mutate(NEC3param=ifelse(grepl("Sig", scenarios), 1-NEC3param, NEC3param)) |> 
  select(total.reps, n, trials, n.treatments, scenarios, NEC3param) |> 
  group_by(total.reps, n.treatments, scenarios) |> 
  summarise(weight=round(median(NEC3param),3), .groups = "keep") |> 
  dplyr::mutate(Treatments = factor(n.treatments)) |> 
  #pivot_wider(names_from = scenarios, values_from = weight) |> 
  ggplot(aes(total.reps, weight, colour = n.treatments)) +
  geom_line() + 
  geom_point() +
  #geom_smooth(aes(x=total.reps, y=weight, color=n.treatments)) +
  scale_colour_manual(values=c("#B3AE36","#2D6480"))+
  labs(x="Total number of trials", colour="Treatments", 
       y ="Median weight") +
  facet_wrap(~scenarios, nrow = 1) +
  theme_minimal() +
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.tag.position=c(0.03, 0.925), 
        plot.tag=element_text(size=8))

  #write.csv(file="weights.csv")
  #View()

plot_grid(grob1, grob2, labels=c("A", "B"), ncol = 1, nrow = 2, rel_heights = c(0.6, 0.3))
ggsave("figure weights.jpg", height=200, width=200, units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 2.jpg", sep=""), height=200, width=200, units="mm", bg = "white")


```


##Figure NSEC

```{r figure nsec,  warning=FALSE}
fig.nsec.dat<- dat %>%
  mutate(NSEC=est.NSEC,
        NEC=NEC_X50.) %>%
  pivot_longer(cols=c("NSEC","NEC"), values_to = "y", names_to = "Value") %>% 
  select(y, n.treatments, total.reps, scenarios, Value, label)  %>% 
  mutate(Value=as_factor(Value),
         Value=fct_relevel(Value, "NSEC", "NEC"),
                 scenarios_f = as_factor(scenarios), 
        scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"))
  
fig_nsec_labels<- data.frame(
    x=1, 
    y=8.5, 
    label=c("(A)", "(B)", "(C)", "(D)", "(E)", "(F)", "(G)", "(H)"),
    scenarios_f=levels(fig.nsec.dat$scenarios_f),
    Value=c(rep("NSEC", 4), rep("NEC", 4))) %>% 
    mutate(Value=factor(Value, levels=c("NSEC", "NEC")))
  

(fig_nsec<-  fig.nsec.dat %>% 
ggplot(aes(label, y)) +
  geom_boxplot(aes(fill=n.treatments), outlier.shape=NA, alpha=1, colour="black")+
  geom_hline(data = na.omit(true.vals.2), aes(yintercept = y, colour=endpoint), lwd=0.7) +  
  #geom_text(data=fig_nsec_labels, aes(x=x,y=y, label=label), fontface="bold")+
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  facet_grid(Value~scenarios_f) +
  scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f")) +
  theme_minimal() +
  scale_y_continuous(limits=c(NA, 8.5))+
  scale_x_discrete()+
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.margin = margin(10, 10, 10, 20),
        panel.spacing.y=unit(1, "lines")) +
  guides(fill = guide_legend(override.aes = list(alpha=1)),
                 colour = guide_legend(override.aes = list(alpha=1))) +  
  labs(x="", 
       y="Estimated value",
       fill="Treatments",
       colour="Estimate"))
 
 ggsave("figure nsec.jpg", height=160, width=240, units="mm", bg = "white")
 
 
 
```
## Figures all_estimates

```{r plot-violin-medians, fig.height=5, fig.width=7, fig.cap="\\label{fig:plot_violin_medians}Median estimated model averaged endpoints estimates for each scenario for a well replicated (n.treatments=12, total.reps=2400) and poorly replicated experiment (n.treatments=8, total.reps=400). Shown as horizontal lines are the true endpoints for each scenario, including EC1, EC10, EC5 and NEC. Note that there is no theoretical NEC for the Sigmoidal scenarios."}
#Plot estimate distribution 

a1dat <- dat %>%
  mutate(NEC=est.NEC,
         NSEC=est.NSEC,
         `N(S)EC`=est.N.S.EC,
         EC10=est.EC10,
         EC05=est.EC05,
         EC01=est.EC01,
         total.reps=factor(total.reps)) %>%
  #filter(label=="5 reps (10 trials)" | label=="10 reps (20 trials)") %>%
  mutate(scenarios_f = as_factor(scenarios), 
        scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) %>% 
  select(NEC, NSEC, `N(S)EC`, EC10, EC05, EC01, scenarios_f, n.treatments, label) %>%
  pivot_longer(cols = c("NEC", "NSEC", "N(S)EC", "EC10", "EC05", "EC01"), values_to="y", names_to="endpoint") %>%
  mutate(endpoint = as_factor(endpoint),
         endpoint = fct_relevel(endpoint, c("NEC", "NSEC", "N(S)EC", "EC10", "EC05", "EC01")))

a1out <- a1dat |> group_by(scenarios_f, n.treatments, label, endpoint) |> 
  summarise(estimate=median(y), .groups = "keep") |> 
  #pivot_wider(names_from = endpoint, values_from = estimate)
  pivot_wider(names_from = scenarios_f, values_from = estimate)

a1 <- a1dat |>   ggplot(aes(x=endpoint, y=y, fill=n.treatments)) +
  geom_boxplot(aes(), outlier.shape=NA, 
               alpha=1, colour="black")+
  #stat_summary(fun.data = quantiles_95, geom="boxplot", position=position_dodge2())  +
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  geom_hline(data = na.omit(true.vals.2), aes(yintercept = y, colour=endpoint)) +
  scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f")) +  
  labs(col="True endpoints", fill="Treatments") + 
  labs(x="", y="Estimated value") + 
  facet_grid(~scenarios_f, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust=0.5))

a2dat <- dat %>%
  dplyr::select(n, n.treatments, total.reps, scenarios, trials, label,
         n.s.ec_ecx_vals, nsec_ecx_vals, ec1_ecx_vals, ec5_ecx_vals, ec10_ecx_vals, nec_ecx_vals)  %>%
  #dplyr::filter(total.reps=="2400" | total.reps=="400") %>%  
  #dplyr::filter(label=="5 reps (10 trials)" | label=="10 reps (20 trials)") %>%
  pivot_longer(cols=contains("ecx_vals"), names_to = "endpoint", values_to = "y") |> 
  dplyr::mutate(endpoint=toupper(gsub("_ecx_vals","", endpoint))) %>%
  dplyr::mutate(endpoint=gsub("N.S.", "N(S)", endpoint)) %>%
  dplyr::mutate(endpoint=ifelse(endpoint == "EC1", "EC01", endpoint)) %>%
  dplyr::mutate(endpoint=ifelse(endpoint == "EC5", "EC05", endpoint)) %>%
  dplyr::select(y, endpoint, n.treatments, total.reps, scenarios, label)  %>% 
  dplyr::mutate(
           scenarios_f = as_factor(scenarios), 
           scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"),
           endpoint = as_factor(endpoint),
           endpoint = fct_relevel(endpoint, c("NEC", "NSEC", "N(S)EC", "EC10", "EC05", "EC01")))

a2out <- a2dat |> group_by(scenarios_f, n.treatments, label, endpoint) |> 
  summarise(effect=median(y), .groups = "keep") |> 
  pivot_wider(names_from = scenarios_f, values_from = effect)
  #pivot_wider(names_from = endpoint, values_from = effect)

a2 <- a2dat |> 
ggplot(aes(x=endpoint, y, fill=n.treatments)) +
  geom_boxplot(aes(), outlier.shape=NA, alpha=1, colour="black")+
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  scale_y_continuous(limits=c(0, 30))+
  scale_x_discrete()+
  labs(x="", y="Actual effect size (%)", fill="Treatments", colour="True ECx") +
  geom_hline(data = true_ec_dat, aes(yintercept = y, colour=endpoint)) +
  scale_colour_manual(values = c("#F08986", "#F02451", "#91003f"))  +
  facet_grid(~scenarios_f, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust=0.5))

precision_dat <- dat %>%
  mutate(NEC=est.NEC,
         NSEC=est.NSEC,
         `N(S)EC`=est.N.S.EC,
         EC10=est.EC10,
         EC05=est.EC05,
         EC01=est.EC01,
         total.reps=factor(total.reps)) %>%
  mutate(scenarios_f = as_factor(scenarios), 
        scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) %>% 
  select(NEC, NSEC, `N(S)EC`, EC10, EC05, EC01, scenarios_f, n.treatments, total.reps) %>%
  pivot_longer(cols = c("NEC", "NSEC", "N(S)EC", "EC10", "EC05", "EC01"), values_to="y", names_to="endpoint") |> 
  mutate(
    endpoint = as_factor(endpoint),
    endpoint = fct_relevel(endpoint, c("NEC", "NSEC", "N(S)EC", "EC01", "EC05", "EC10")))
       
e1 <- precision_dat |> 
  group_by(total.reps, n.treatments, scenarios_f, endpoint) |> 
  dplyr::summarise(cv=(quantile(y, 0.75) - quantile(y, 0.25))/(quantile(y, 0.75)+quantile(y, 0.25)), 
                   .groups = "keep") |> 
  dplyr::mutate(Treatments = factor(n.treatments),
                total.reps=as.numeric(as.character(total.reps))) |> 
  #head()
 ggplot(aes(total.reps, cv, colour = n.treatments)) +
  geom_line() + 
  geom_point() +
  scale_colour_manual(values=c("#B3AE36","#2D6480"))+
  labs(x="Total number of trials", colour="Treatments", 
       y ="Coefficient of variablity") +
  facet_grid(scenarios_f~endpoint, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_markdown(angle = 45, hjust=1))

effects_dat <-  dat %>%
  dplyr::select(n, n.treatments, total.reps, scenarios, trials, label,
         n.s.ec_ecx_vals, nsec_ecx_vals, ec1_ecx_vals, ec5_ecx_vals, ec10_ecx_vals, nec_ecx_vals)  %>%
  pivot_longer(cols=contains("ecx_vals"), names_to = "endpoint", values_to = "estimate") |> 
  dplyr::mutate(endpoint=toupper(gsub("_ecx_vals","", endpoint))) %>%
  dplyr::mutate(endpoint=gsub("N.S.", "N(S)", endpoint)) %>%
  dplyr::mutate(endpoint=ifelse(endpoint == "EC1", "EC01", endpoint)) %>%
  dplyr::mutate(endpoint=ifelse(endpoint == "EC5", "EC05", endpoint)) %>%
  dplyr::select(estimate, endpoint, n.treatments, total.reps, scenarios, label)  %>% 
  dplyr::mutate(
           scenarios_f = as_factor(scenarios), 
           scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"),
           endpoint = as_factor(endpoint),
           endpoint = fct_relevel(endpoint, c("NEC", "NSEC", "N(S)EC", "EC01", "EC05", "EC10"))) |> 
  left_join(true_all_dat) |> 
  mutate(diff=estimate-y)

e2 <- effects_dat |> 
    select(total.reps, label, n.treatments, scenarios_f, endpoint, diff) |> 
  group_by(total.reps, n.treatments, scenarios_f, endpoint) |> 
  summarise(diff=median(diff), .groups = "keep") |> 
  dplyr::mutate(Treatments = factor(n.treatments)) |> 
  #View()
 ggplot(aes(total.reps, diff, colour = n.treatments)) +
  geom_line() + 
  geom_point() +
  scale_colour_manual(values=c("#B3AE36","#2D6480"))+
  labs(x="Total number of trials", colour="Treatments", 
       y ="Median difference from expected") +
  facet_grid(scenarios_f~endpoint, scales = "free_y") +
  geom_hline(yintercept = 0, col="blue", lty=2) +
  theme_minimal() +
  theme(axis.text.x = element_markdown(angle = 45, hjust=1))


plot_grid(a1, e1, labels=c("A", "B"), ncol = 1, nrow = 2, rel_heights = c(0.5, 0.5))

ggsave("figure all_estimates.jpg", height=200, width=240, units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 3.jpg", sep=""), height=200, width=240, units="mm", bg = "white")

plot_grid(a2, e2, labels=c("A", "B"), ncol = 1, nrow = 2, rel_heights = c(0.5, 0.5))

ggsave("figure all_effects.jpg", height=200, width=240, units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 4.jpg", sep=""), height=200, width=240, units="mm", bg = "white")

vars <- c("NEC", "NSEC", "N(S)EC", "EC10", "EC05", "EC01")
vars <-c("NEC 1", "NEC 2", "Sigmoidal 1", "Sigmoidal 2")

cbind(a1out[, c("endpoint", "n.treatments", "label")], 
            signif(a1out[, vars], 3), 
            signif(a2out[, vars], 3)) |> 
  data.frame() |> 
  write.csv("sime_estimates.csv")
  

```
##Figure cs1 (copper)

Case study demonstrating model averaging

```{r}
str(all_endpoint_dat)
str(all_fit_dat)

#back transform function 
back_fun<- function(x)(x^2)

#model weights 
cs_cu_weights <- read_csv("cs_cu_weights.csv") %>% dplyr::select(Model, DIC, wi)

cu_wi_ord<- cs_cu_weights %>% arrange(desc(wi)) %>%  
  dplyr::select(Model) %>%  unique() %>% pull() 

cu_wi<- c("Averaged", cu_wi_ord)

cu_wi_top<- cs_cu_weights %>% arrange(desc(wi)) %>% slice(1:3) 
cu_lab1<- cs_cu_weights %>% arrange(desc(wi)) %>% #arrange by weights 
    mutate(Model= factor(Model, levels = cu_wi_ord)) %>% #reorder the levels based on weights
  filter(wi>0)#filter only the models with weight

#cu data

cu_dat <- read.csv("ignore/C. armigera combined.csv") %>% 
  dplyr::filter(Metal == "Cu") %>% 
  rename(x=Conc) %>% 
#  dplyr::mutate(log.x = log(Conc + 1), 
#                x=if_else(Conc<0.1, 0.1, Conc)) %>% 
    mutate(y=Pcon/100)#convert to proportion from percent


cu_mods<- data.frame(Model=c((cu_wi_top$Model), "Averaged"))
cu_dat_plus<- crossing(cu_dat, cu_mods) %>% 
  mutate(type = if_else(Model=="Averaged", "Averaged", 
                        if_else(startsWith(Model, "NEC"),"NEC","Sigmoidal"))) %>% 
    filter(Model %in% c(cu_lab1$Model) | Model == "Averaged")

#Estimates 

endpoints<- all_endpoint_dat %>% 
      rename(value="X50.", lw="X2.5.", up="X97.5.") %>% #rename median and interval values 
  mutate(value=as.double(value), lw=as.double(lw), up=as.double(up), #make values numeric
         Model = fct_recode(as.factor(Model),Averaged="averaged")) %>%  #capitalise averaged 
  mutate(across(where(is.double),~back_fun(.x))) %>% #back transformation

    filter(Model %in% c(cu_wi_top$Model) | Model == "Averaged") %>% #only select models with weight or the averaged model
  mutate(x=15, y=0.25, 
         label=str_c(estimate,": ", round(value,0), " (",round(lw,0),"-", round(up,0),")" ,sep=""))


#labels for ECx values 
Cu_EC_labs<- Cu_EC_estimates %>% 
   mutate(estimate = if_else(Model=="Averaged", "Averaged", 
                        if_else(startsWith(Model, "NEC"),"NEC","Sigmoidal"))) %>% 

    filter(Model %in% c(cu_wi_top$Model) | Model == "Averaged") %>% 
    droplevels() %>% 
    mutate(label=str_c(ECx,": ", round(value,0), " (",round(lw,0),"-", round(up,0),")" ,sep=""),
           x=15,y=if_else(ECx== "EC1", 0.15,0.05))

Cu_EC10<- Cu_EC_labs %>% filter(ECx=="EC10")
Cu_EC1<- Cu_EC_labs %>% filter(ECx=="EC1")

#lines and ribbons 

  fit_dat<- all_fit_dat %>% 
         mutate(Model = fct_recode(as.factor(Model),Averaged="averaged")) %>% 
      mutate(x=back_fun(x)) %>% #back transformation
  left_join(cs_cu_weights %>%rename("Model"=1) ) %>% 
  mutate(Model= factor(Model, levels = cu_wi))%>% 
  filter(Model%in% cu_wi_top$Model | Model=="Averaged") %>% 
  mutate(type = if_else(Model=="Averaged", "Averaged", 
                        if_else(startsWith(as.character(Model), "NEC"),"NEC","Sigmoidal")))

  
  
  fig_cs1_labels<- data.frame(
    x=0, 
    y=1.20, 
    Model=c("Averaged", (cu_wi_top$Model)),     
    label=c("(A)", "(B)", "(C)", "(D)")) 

  #to do: 
#separate averaged - recombine in single graph
#fix factor relevel not passing to facet 


(fig_cs1<-ggplot(data=fit_dat)+
  geom_ribbon(data=fit_dat, aes(x=x, y=y,ymin=lw, ymax=up, fill=type),linetype=2, alpha=0.2, show.legend=FALSE)+
  geom_line(data=fit_dat, aes(x=x, y=y, colour=type), lwd=0.5)+
  geom_point(data=cu_dat_plus, aes(x=x, y=y, fill=type), pch=21, alpha=0.1)+
  geom_text(data=Cu_EC1, aes(label=label, x=x, y=y, colour=estimate), size=3, hjust=0,show.legend = FALSE)+
  geom_text(data=Cu_EC10, aes(label=label, x=x, y=y, colour=estimate), size=3, hjust=0,show.legend = FALSE)+

  scale_fill_manual(values=c("#704FC4","black"), name="Model")+
  scale_colour_manual(values=c("#704FC4","black"), name="Model")+
  
  new_scale_color()+
  new_scale_fill()+
  geom_rect(data=endpoints, aes(xmax=(up), xmin=(lw), ymin=-Inf, ymax=Inf, x=x, y=y, fill=estimate), alpha=0.2)+
  geom_text(data=endpoints, aes(label=label, x=x, y=y, colour=estimate), size=3, hjust=0,show.legend = FALSE)+
  geom_vline(data=endpoints, aes(xintercept=(value), colour=estimate),  lwd=0.8)+
    
  geom_text(data=fig_cs1_labels, aes(x=x,y=y, label=label), fontface="bold")+

  scale_colour_manual(values=c("#815BE3","black"), name="Estimate")+
  scale_fill_manual(values=c("#815BE3","black"), name="Estimate")+


  scale_x_continuous(trans="sqrt", labels = scales::label_number(accuracy=1), breaks=c(0.1,1,10,20, 50, 100))+
  scale_y_continuous(limits=c(0,1.4), breaks=c(0,0.20,0.40,0.60,0.80,1.00))+

  facet_wrap(~Model, ncol=2)+
  theme_minimal()+
  theme(axis.ticks = element_line(),
        panel.grid.minor = element_blank())+
  labs(x=expression("Concentration"~ (mu*g~{L^-1}~Cu)), y="Normalised response"))



ggsave("figure 5.jpg", height=180,width=200, units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 5.jpg", sep=""), height=180,width=200, units="mm", bg = "white")


```



##Figure cs2 (condensate)

Case study using data from a study that investigated the the effects of 40% weathered Ichthys condensate WAF on four tropical marine species. 


```{r figure cs2, fig.height=7, fig.width=7, fig.cap="\\label{fig:plot_CRs}Concentration response relationships.", warning=FALSE}
load("Case_study_condensate_for_plotting.RData")

#convert transformed concentrations back to concentrations
cs_endpoints_2<- cs_endpoints %>% 
  mutate(med =xform1(as.numeric(`50%`)), 
         lw=xform1(as.numeric(`2.5%`)), 
         up=xform1(as.numeric(`97.5%`)),
         endpoint=fct_recode(endpoint, `N(S)EC`="NSEC")) 

#shuffle any 0 or near 0 values up a little to plot on a log scale
cs_dat_2<- cs_dat %>% 
  mutate(x_num = xform1(x)) %>% 
  mutate(x_num=if_else(x_num<0.1, 0.1, x_num))

cs_predat_2<- cs_predat %>% 
  mutate(x_num=xform1(x)) %>% 
  mutate(x_num=if_else(x_num<0.1, 0.1, x_num)) %>% 
  mutate(fit=fct_recode(fit, "All" = "all"))


#text annotations

label_1 <- data.frame(label = c("NEC3param 0.95", "ECxWeibull2 0.41","ECxWeibull1 0.75","ECxWeibull2 0.59"),
                      sp = unique(cs_dat$sp), 
                       x=0.2, y=0.25)

label_2<- data.frame(label = c("ECxWeibull2 0.05", "NEC4param 0.38", "NEC3param 0.25", "ECxWeibull1 0.41"),
                      sp = unique(cs_dat$sp), 
                       x=0.2, y=0.15)
label_3<- data.frame(label = c( "", "ECxWeibull1 0.21",  "", "" ),
                      sp = unique(cs_dat$sp), 
                       x=0.2, y=0.05)

#plot facet labels
  
  fig_cs2_labels<- data.frame(
    x=0.05, 
    y=1.1, 
    sp= unique(cs_dat$sp), 
    label=c("(A)", "(B)", "(C)", "(D)")) 


(fig.cs2<-ggplot()+
  geom_ribbon(data=cs_predat_2, aes(x=x_num, y=y,ymin=lw, ymax=up, fill=fit),linetype=2, alpha=0.2)+
  geom_line(data=cs_predat_2, aes(x=x_num, y=y,colour=fit), lwd=0.5)+
  geom_point(data=cs_dat_2, aes(x=x_num, y=y),alpha=0.1)+
  geom_text(data=label_1, aes(x=x, y=y, label=label),size=3, hjust=0)+
  geom_text(data=label_2, aes(x=x, y=y, label=label),size=3, hjust=0)+
  geom_text(data=label_3, aes(x=x, y=y, label=label),size=3, hjust=0)+
  geom_text(data=fig_cs2_labels, aes(x=x, y=y, label=label), fontface="bold")+

  scale_colour_manual(values=c("#704FC4", "#16ABA5"), name="Model average \n group")+
  scale_fill_manual(values=c("#704FC4", "#16ABA5"), name="Model average \n group")+
  new_scale_color()+
  new_scale_fill()+
  geom_segment(data=cs_endpoints_2, aes(x=med, xend=med, y=0, yend=1, colour=endpoint, linetype=endpoint),lwd=0.8)+
  scale_colour_manual(values=c("#91003f","#41b6c4","#815BE3"), name="Estimate")+
  scale_x_log10(breaks=c(1, 10, 100, 1000, 10000))+
    scale_linetype_manual(values=c(3,2,1), name="Estimate")+
  facet_wrap(sp~., nrow=2)+
  theme_minimal()+
  theme(strip.text=element_text(face="bold.italic"),
        axis.ticks = element_line(),
        panel.grid.minor = element_blank())+
  labs(x=expression("Concentration"~ (mu*g~{L^-1}~TAH)), 
       y= "Normalised response",
       fill="Model group",colour="Model group"))


ggsave("figure cs2.jpg", height=180, width=200,units="mm", bg = "white")
ggsave(paste(fig_dir,"figure 6.jpg", sep=""), height=180,width=200, units="mm", bg = "white")

```


# Bonus plots 



```{r alleffects,  warning=FALSE}

fig.dat_all<- dat %>%
  select(n, n.treatments, total.reps, scenarios, trials, label,
         nsec_ecx_vals, ec1_ecx_vals, ec5_ecx_vals, ec10_ecx_vals, nec_ecx_vals)  %>%
  #filter(total.reps=="2400" | total.reps=="400") %>%  
  pivot_longer(cols=contains("ecx_vals"), names_to = "endpoint", values_to = "y") |> 
  mutate(endpoint=toupper(gsub("_ecx_vals","", endpoint))) %>%
  select(y, endpoint, n.treatments, total.reps, scenarios, label)  %>% 
  mutate(scenarios_f = as_factor(scenarios), 
         scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"),
         endpoint = fct_relevel(endpoint, "EC1", "EC5", "EC10", "NSEC"))

fig.dat_all %>% 
ggplot(aes(x=endpoint, y, fill=label)) +
  #stat_summary(fun.data = quantiles_95, geom="boxplot", 
  #             aes(group=interaction(label, n.treatments)),
  #             position=position_dodge(.9))  +
  geom_boxplot(aes(fill=label), outlier.shape=NA, alpha=1, colour="black")+
  #scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  facet_grid(scenarios_f ~ n.treatments) +
  theme_minimal() +
  scale_y_continuous(limits=c(0, 30))+
  scale_x_discrete()+
  #geom_text(data=fig_effects_labels, aes(x=x,y=y, label=label), fontface="bold")+
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.margin = margin(10, 10, 10, 20),
        panel.spacing.y=unit(1, "lines")) +
  guides(fill = guide_legend(override.aes = list(alpha=1)),
                 colour = guide_legend(override.aes = list(alpha=1))) +  
  labs(x="", 
       y="Actual effect size",
       fill="Design",
       colour="True ECx") +
   geom_hline(yintercept = 1, col = "#F08986") +
   geom_hline(yintercept = 5, col =  "#F02451") +
   geom_hline(yintercept = 10, col = "#91003f") +
  scale_color_manual(values = c("EC1", "EC5", "EC10"))

ggsave("figure all_effects_.jpg", height=160, width=240, units="mm", bg = "white")
 

```


```{r allestimates2,  warning=FALSE}

dat %>%
  mutate(NEC=est.NEC,
         `N(S)EC`=est.NSEC,
         EC10=est.EC10,
         EC05=est.EC05,
         EC01=est.EC01,
         total.reps=factor(total.reps)) %>%
  #filter(total.reps=="2400" | total.reps=="400") %>%
  mutate(scenarios_f = as_factor(scenarios), 
        scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2")) %>% 
  select(NEC, `N(S)EC`, EC10, EC05, EC01, scenarios_f, n.treatments, label) %>%
  #mutate(fact=paste(scenarios_f, total.reps)) %>%
  pivot_longer(cols = c("NEC", "N(S)EC", "EC10", "EC05", "EC01"), values_to="y", names_to="endpoint") %>%
ggplot(aes(x=label, y, fill=n.treatments)) +
  stat_summary(fun.data = quantiles_95, geom="boxplot", 
               aes(group=interaction(label, n.treatments)),
               position=position_dodge(.9))  +
  #geom_boxplot(aes(fill=n.treatments), alpha=1, colour="black") +
  #ggh4x::facet_grid2(scenarios_f ~ endpoint, scales = "free_y") + 
  facet_grid(scenarios_f ~ endpoint, scales = "free_y") +  
  #facet_wrap(vars(scenarios_f, endpoint), scales = "free_y") +  
  theme_minimal() +
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.margin = margin(10, 10, 10, 20),
        panel.spacing.y=unit(1, "lines")) +
  guides(fill = guide_legend(override.aes = list(alpha=1)),
                 colour = guide_legend(override.aes = list(alpha=1))) +   
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  #geom_hline(data = na.omit(true.vals.2), aes(yintercept = y, colour=endpoint)) #+
  #scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f")) #+  
  labs(col="True endpoints") + 
  scale_x_discrete()+
  #geom_text(data=fig_effects_labels, aes(x=x,y=y, label=label), fontface="bold")+
  labs(x="", 
       y="Estimate",
       fill="Design")  

ggsave("figure all_estimates.jpg", height=160, width=240, units="mm", bg = "white")
 

```


```{r alleffects2,  warning=FALSE}

fig.dat_all<- dat %>%
  select(n, n.treatments, total.reps, scenarios, trials, label,
         nsec_ecx_vals, ec1_ecx_vals, ec5_ecx_vals, ec10_ecx_vals, nec_ecx_vals)  %>%
  #filter(total.reps=="2400" | total.reps=="400") %>%  
  pivot_longer(cols=contains("ecx_vals"), names_to = "endpoint", values_to = "y") |> 
  mutate(endpoint=toupper(gsub("_ecx_vals","", endpoint))) %>%
  select(y, endpoint, n.treatments, total.reps, scenarios, label)  %>% 
  mutate(scenarios_f = as_factor(scenarios), 
         scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"),
         endpoint = fct_relevel(endpoint, "EC1", "EC5", "EC10", "NSEC"))

fig.dat_all %>% 
ggplot(aes(x=label, y, fill=n.treatments)) +
  #stat_summary(fun.data = quantiles_95, geom="boxplot", 
  #             aes(group=interaction(label, n.treatments)),
  #             position=position_dodge(.9))  +
  geom_boxplot(aes(fill=n.treatments), outlier.shape=NA, alpha=1, colour="black")+
  #scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  #facet_grid(scenarios_f ~ endpoint) +
  ggh4x::facet_grid2(scenarios_f ~ endpoint, scales = "free_y") +  
  theme_minimal() +
  scale_y_continuous(limits=c(0, 30))+
  scale_x_discrete()+
  #geom_text(data=fig_effects_labels, aes(x=x,y=y, label=label), fontface="bold")+
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.margin = margin(10, 10, 10, 20),
        panel.spacing.y=unit(1, "lines")) +
  guides(fill = guide_legend(override.aes = list(alpha=1)),
                 colour = guide_legend(override.aes = list(alpha=1))) +  
  labs(x="", 
       y="Actual effect size",
       fill="Design",
       colour="True ECx") +
   geom_hline(yintercept = 1, col = "#F08986") +
   geom_hline(yintercept = 5, col =  "#F02451") +
   geom_hline(yintercept = 10, col = "#91003f") +
  scale_color_manual(values = c("EC1", "EC5", "EC10"))

ggsave("figure all_effects_.jpg", height=160, width=240, units="mm", bg = "white")
 

```

##Figure NSEC effects

```{r effects,  warning=FALSE}


fig.dat<- dat %>%
  mutate(y=nsec_ecx_vals,
         label=paste(n, " reps (", trials, " trials)", sep="")) %>%
  select(y, n.treatments, total.reps, scenarios, label)  %>% 
  mutate(scenarios_f = as_factor(scenarios), 
        scenarios_f = fct_relevel(scenarios_f, "NEC 1", "NEC 2", "Sigmoidal 1" , "Sigmoidal 2"))

  fig_effects_labels<- data.frame(x=1, y=40, 
    label=c("(A)", "(B)", "(C)", "(D)"),
    scenarios_f=levels(fig.dat$scenarios_f),
    Value=c(rep("NSEC", 4), rep("NEC", 4)))
  

fig.dat %>% 
ggplot(aes(label, y)) +
  geom_boxplot(aes(fill=n.treatments), outlier.shape=NA, alpha=1, colour="black")+
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  facet_wrap(~scenarios_f) +
  scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f")) +
  theme_minimal() +
  scale_y_continuous(limits=c(0, 40))+
  scale_x_discrete()+
  geom_text(data=fig_effects_labels, aes(x=x,y=y, label=label), fontface="bold")+
  theme(axis.text.x = element_markdown(angle = 45, hjust=1, face="bold"),
        plot.margin = margin(10, 10, 10, 20),
        panel.spacing.y=unit(1, "lines")) +
  guides(fill = guide_legend(override.aes = list(alpha=1)),
                 colour = guide_legend(override.aes = list(alpha=1))) +  
  labs(x="", 
       y="NSEC estimated equivalent effect size",
       fill="Treatments",
       colour="Estimate")
 
 ggsave("figure effects.jpg", height=160, width=240, units="mm", bg = "white")
 
 # dat |> dplyr::filter(nsec_ecx_vals>30 & scenarios == "NEC 2") |> 
 #   dplyr::select(NEC_X50.) |> 
 #  View()
 
```


```{r NSEC NEC comparison figure, fig.cap="\\label{fig:plot_4}Median estimated model averaged NSEC values based on a 99% certainty value for each scenario as a function of estimated NEC from the same data. Shown as horizontal and vertical lines are the true toxicity estimates for each scenario, including EC1, EC10, EC5 and NEC. Note that there is no theoretical NEC for the sigmoidal scenarios, although an ‘NEC’ estimate was obtained using the NEC model. The diagonal black line shows the 1:1 relationship indicating where NSEC estimates are equal to estimated NEC. Points are coloured according to the total sample size (total.reps, number of replicates x number of individuals).", warning=FALSE}

cols <- colorRampPalette(c("purple","darkgrey","black"))(length(unique(all.sim.out$total.reps)))
total.reps.levels <- as.character(sort(unique(all.sim.out$total.reps)))
tot_colour_ramp = c("#D4CF3F","#4AA6D4", "#B3AE36","#2D6480", "#6E6B21", "#1D4254")

true.vals<- true.vals %>% mutate(endpoint=fct_relevel(endpoint, "NEC", "EC1", "EC5", "EC10"))
plotdat.all.sim.out<- all.sim.out %>%
 mutate(NEC=NEC_X50.,
NSEC=NSEC01.ECxsigmoidal_X50.*ECxsigmoidal + NSEC01.NEC3param_X50.*NEC3param,
EC10=ECx10.ECxsigmoidal_X50.*ECxsigmoidal + ECx10.NEC3param_X50.*NEC3param,
EC05=ECx05.ECxsigmoidal_X50.*ECxsigmoidal + ECx05.NEC3param_X50.*NEC3param,
EC01=ECx01.ECxsigmoidal_X50.*ECxsigmoidal + ECx01.NEC3param_X50.*NEC3param) %>%
select(NEC, NSEC, EC10, EC05, EC01, scenarios, n.treatments, total.reps) %>%
#mutate(total.reps=as.factor(total.reps)) %>% 
na.omit()

plotdat.all.sim.out.t8<- plotdat.all.sim.out %>% filter(n.treatments==8) %>% 
  mutate(reps= as.factor(total.reps), 
         reps=fct_recode(reps,
                          "5 reps (10 trials)" = "400",
                          "5 reps (20 trials)"="800",
                          "10 reps (20 trials)" ="1600", 
                         ))
plotdat.all.sim.out.t12<- plotdat.all.sim.out %>% filter(n.treatments==12) %>% 
  mutate(reps= as.factor(total.reps), 
         reps=fct_recode(reps,
                          "5 reps (10 trials)" = "600",
                          "5 reps (20 trials)"="1200",
                          "10 reps (20 trials)" ="2400", 
                         ))

ggplot(plotdat.all.sim.out.t8) +
geom_point( aes(NEC, NSEC,fill=reps), alpha=0.3, pch=21) +
scale_fill_manual(values=c("#D4CF3F", "#B3AE36", "#6E6B21"), name="8 treatments")+
guides(fill = guide_legend(override.aes = list(alpha=1))) +  

  new_scale_fill() +
geom_point(data=plotdat.all.sim.out.t12, aes(NEC, NSEC,fill=reps), alpha=0.3, pch=21) +
scale_fill_manual(values=c("#4AA6D4","#2D6480","#1D4254"), name="12 treatments")+
geom_segment(data = na.omit(true.vals), aes(x=0, y=y, xend=y, yend = y, colour=endpoint), lwd=0.5)+
geom_segment(data = na.omit(true.vals), aes(x=y, y=0, xend=y, yend = y, colour=endpoint), lwd=0.5)+
geom_abline(aes(intercept = 0, slope = 1, linetype = "dashed"), show.legend = FALSE, lwd=0.5) +
labs(x="Estimated NEC", y="Estimated NSEC")+


scale_colour_manual(values = c("#41b6c4", "#F08986", "#F02451", "#91003f"), name="Estimate") +
guides(colour = guide_legend(order = 1))+
facet_wrap(~scenarios, scales="free") +
  guides(fill = guide_legend(override.aes = list(alpha=1))) +  

theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust=1))

```


```{r plot-cbands, fig.height=5, fig.width=7, fig.cap="\\label{fig:plot_cbands}Estimated 95% confidence band range for model averaged endpoints estimates for each scenario for a well replicated (n.treatments=12, total.reps=2400) and poorly replicated experiment (n.treatments=8, total.reps=400)"}
#Plot of confidence bands of the estimates
all.sim.out %>%
  mutate(NEC.lw=NEC_X2.5.,
         NSEC.lw=NSEC01.ECxsigmoidal_X2.5.*ECxsigmoidal + NSEC01.NEC3param_X2.5.*NEC3param,
         EC10.lw=ECx10.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx10.NEC3param_X2.5.*NEC3param,
         EC5.lw=ECx05.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx05.NEC3param_X2.5.*NEC3param,
         EC1.lw=ECx01.ECxsigmoidal_X2.5.*ECxsigmoidal + ECx01.NEC3param_X2.5.*NEC3param,
         NEC.up=NEC_X97.5.,
         NSEC.up=NSEC01.ECxsigmoidal_X97.5.*ECxsigmoidal + NSEC01.NEC3param_X97.5.*NEC3param,
         EC10.up=ECx10.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx10.NEC3param_X97.5.*NEC3param,
         EC5.up=ECx05.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx05.NEC3param_X97.5.*NEC3param,
         EC1.up=ECx01.ECxsigmoidal_X97.5.*ECxsigmoidal + ECx01.NEC3param_X97.5.*NEC3param,
         NEC=NEC.up-NEC.lw,
         NSEC=NSEC.up-NSEC.lw,
         EC10=EC10.up-EC10.lw,
         EC05=EC5.up-EC5.lw,
         EC01=EC1.up-EC1.lw,         
         total.reps=factor(total.reps)) %>%
  filter(total.reps=="2400" | total.reps=="400") %>%
  select(NEC, NSEC, EC10, EC05, EC01, scenarios, n.treatments, total.reps) %>%
  pivot_longer(cols = c("NEC", "NSEC", "EC10", "EC05", "EC01"), values_to="y", names_to="endpoint") %>%
  ggplot(aes(endpoint, y, fill=n.treatments))+
  geom_split_violin(col="black", alpha=0.7) +
  scale_fill_manual(values=c("#B3AE36","#2D6480"))+
  labs(y="Estimated value", fill="Treatments") + 
  coord_cartesian(ylim=c(0,2))+
  facet_wrap(~scenarios, nrow=2) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))


```


```{r plot-exceedance, fig.height=7, fig.width=7, fig.cap="\\label{fig:plot_coverage}Exceedance rates from 100 simulations as a function of the total number of simulated replicates (total.reps). Shown are exceedance rates for the actual endpoint estimates, including EC1, EC10, EC5 and NEC; as well as the estimate based on NSEC for those same endpoints. The dashed horizontal line indicates the expected 0.025 probability, assuming errors are equal at each end of the credible interval. Note that there is no theoretical NEC for the Sigmoidal scenarios.", warning=FALSE}
coverage %>% 
  pivot_longer(cols=c("fp.NEC", "fp.EC10", "fp.EC05", "fp.EC01", 
                      "ns_fp.NEC", "ns_fp.EC10",  "ns_fp.EC05", "ns_fp.EC01",
                      "fn.NEC", "fn.EC10", "fn.EC05", "fn.EC01", 
                      "ns_fn.NEC", "ns_fn.EC10",  "ns_fn.EC05",  "ns_fn.EC01",
                      "nec_fn.NEC", "nec_fn.EC10",  "nec_fn.EC05",  "nec_fn.EC01",
                      "nec_fp.NEC", "nec_fp.EC10",  "nec_fp.EC05",  "nec_fp.EC01"),
               names_to = "endpoint", values_to = "coverage") %>% 
  dplyr::mutate(type=ifelse(grepl("ns_", endpoint), 
                            "NSEC", ifelse(grepl("nec_", endpoint), "NEC", "Actual")),
                error=ifelse(grepl("fp.", endpoint), 
                            "(FP/1)", "(FN/2)")) %>%
  unite(col = "type", type, error, sep = " ") %>% 
  dplyr::mutate(endpoint=gsub("nec_", "", gsub("ns_", "", gsub("fn.", "", 
                              gsub("fp.", "", endpoint))))) %>% 
  ggplot(aes(x=total.reps, y=coverage, colour=endpoint)) +
  geom_point(position = position_jitter()) +
  geom_abline(slope=0, intercept=0.025, lty=2) +
  ylab("Exceedance rate") +
  xlab("Total number of trials in binomial experiment") +
  facet_grid(rows=vars(scenarios), cols=vars(type), scales = "fixed") +
  scale_colour_manual(values = c("orange", "cyan", "blue", "red")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```

